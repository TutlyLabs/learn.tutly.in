---
import db from "@/lib/db";
import RootLayout from "@/layouts/RootLayout.astro";
import UserCards from "./_components/UserCards";

const user = Astro.locals.user;

if (user?.role !== "INSTRUCTOR" || !user) {
  return Astro.redirect("/404");
}

if (user?.isAdmin) {
  return Astro.redirect("/404");
}

const searchTerm = Astro.url.searchParams.get("search") || "";
const filters = Astro.url.searchParams.getAll("filter");
const page = parseInt(Astro.url.searchParams.get("page") || "1");
const limit = parseInt(Astro.url.searchParams.get("limit") || "12");
const onlineCutoff = new Date(Date.now() - 2 * 60 * 1000);

const activeFilters = filters
  .map((f) => {
    const [column, operator, value] = f.split(":");
    return { column, operator, value };
  })
  .filter((f) => f.column && f.operator && f.value);

let where: Record<string, any> = {
  role: {
    in: ["STUDENT", "MENTOR"],
  },
  organizationId: user.organizationId,
};

if (searchTerm) {
  where.OR = [
    { name: { contains: searchTerm, mode: "insensitive" } },
    { username: { contains: searchTerm, mode: "insensitive" } },
    { email: { contains: searchTerm, mode: "insensitive" } },
  ];
}

activeFilters.forEach((filter) => {
  const { column, operator, value } = filter;

  if (typeof column === "string") {
    switch (operator) {
      case "contains":
        where[column] = { contains: value, mode: "insensitive" };
        break;
      case "equals":
        where[column] = value;
        break;
      case "online":
        where.lastSeen = { gte: onlineCutoff };
        break;
    }
  }
});

const [totalItems, activeCount] = await Promise.all([
  db.user.count({ where }),
  db.user.count({
    where: {
      ...where,
      lastSeen: { gte: onlineCutoff },
    },
  }),
]);

const users = await db.user.findMany({
  where,
  orderBy: [
    {
      lastSeen: {
        sort: "desc",
        nulls: "last",
      },
    },
  ],
  select: {
    id: true,
    name: true,
    username: true,
    email: true,
    mobile: true,
    image: true,
    role: true,
    lastSeen: true,
    createdAt: true,
    updatedAt: true,
  },
  skip: (page - 1) * limit,
  take: limit,
});
---

<RootLayout title="Users">
  <UserCards data={users} totalItems={totalItems} activeCount={activeCount} client:load />
</RootLayout>
