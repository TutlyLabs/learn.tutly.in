---
import RootLayout from "@/layouts/RootLayout.astro";
import Page from "./page";
import { createServerCaller } from "@/trpc/server";

const user = Astro.locals.user;

if (user?.role !== "INSTRUCTOR") {
  return Astro.redirect("/404");
}

const searchParams = Astro.url.searchParams;
const page = parseInt(searchParams.get("page") || "1");
const limit = parseInt(searchParams.get("limit") || "10");
const search = searchParams.get("search") || "";
const sort = searchParams.get("sort") || "last-login";
const role = searchParams.get("role");
const showOnline = searchParams.get("online-only") === "true";

const skip = (page - 1) * limit;

const onlineCutoff = new Date(Date.now() - 2 * 60 * 1000);

const orderBy = {
  "last-login": { lastSeen: "desc" },
  "active-desc": { lastSeen: "asc" },
  "name-asc": { name: "asc" },
  "name-desc": { name: "desc" },
  "join-date-desc": { createdAt: "desc" },
  "join-date-asc": { createdAt: "asc" },
}[sort] as any;

const caller = await createServerCaller(Astro.request);

const [users, totalCount, activeCount] = await caller.users.getActivityData({
  search,
  role: role || '',
  skip,
  limit,
  orderBy,
  showOnline,
  onlineCutoff,
})
---

<RootLayout title="Users">
  <Page
    users={users}
    totalCount={totalCount}
    activeCount={activeCount}
    limit={limit}
    client:load
  />
</RootLayout>
