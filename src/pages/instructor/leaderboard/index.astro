---
import RootLayout from "@/layouts/RootLayout.astro";
import Page from "./page";
import { createServerCaller } from "@/trpc/server";

const currentUser = Astro.locals.user;
if (!currentUser) return null;

const searchParams = Astro.url.searchParams;
const selectedCourse = searchParams.get("course");
const selectedMentor = searchParams.get("mentor");

const caller = await createServerCaller(Astro.request);

const [courses, mentors, submissions] = await caller.leaderboard.leaderboardForInstructor({
  selectedCourse: selectedCourse || "",
});

// TODO: Fix this
const totalPoints = submissions?.map((submission) => {
  // @ts-ignore
  const totalPoints = submission.points.reduce(
    (acc: number, curr: { score: number | null }) => acc + (curr.score ?? 0),
    0
  );
  return { ...submission, totalPoints };
});

// @ts-ignore

const sortedSubmissions = totalPoints
  .sort((a, b) => b.totalPoints - a.totalPoints)
  .map((submission, index) => ({
    ...submission,
    rank: index + 1,
  }));

// @ts-ignore
const publishedCourses = courses.filter((course) => course.isPublished);
const enrolledCourses = currentUser.role === "INSTRUCTOR" ? courses : publishedCourses;
---

<RootLayout title="Leaderboard">
  <Page
    submissions={sortedSubmissions}
    courses={enrolledCourses}
    currentUser={currentUser}
    mentors={mentors}
    selectedCourse={selectedCourse}
    selectedMentor={selectedMentor}
    client:load
  />
</RootLayout>
