---
import RootLayout from "@/layouts/RootLayout.astro";
import { actions } from "astro:actions";
import { Course } from "@prisma/client";
import { DataItem } from "./_components/Report.tsx";
import Page from "./page";
import { createServerCaller } from "@/trpc/server";

const { courseId } = Astro.params;

const call = Astro.callAction;
if (!courseId) {
  return Astro.redirect("/instructor/courses", 302);
}

const caller = await createServerCaller(Astro.request);

const { data } = await caller.report.generateReport({ courseId });
const report = data;
const sortedData = report ? [...report].sort((a, b) => a.username.localeCompare(b.username)) : [];
const { data: coursesData } = await call(actions.courses_getAllCourses, {});
const courses = coursesData?.data;
---

<RootLayout title="Report">
  <Page
    sortedData={sortedData as DataItem[]}
    courses={courses as Course[]}
    courseId={courseId}
    client:load
  />
</RootLayout>
