---
import RootLayout from "@/layouts/RootLayout.astro";
import db from "@/lib/db";
import { InstructorAssignments } from "./_components/InstructorAssignments.tsx";

const currentUser = Astro.locals.user!;

const students = await db.user.findMany({
  where: {
    role: "STUDENT",
  },
  include: {
    course: true,
    enrolledUsers: true,
  },
});

let courses = await db.course.findMany({
  where: {
    enrolledUsers: {
      some: {
        username: currentUser.username,
      },
    },
  },
  include: {
    classes: true,
    createdBy: {
      select: {
        id: true,
        username: true,
        name: true,
        image: true,
        email: true,
        role: true,
        createdAt: true,
        updatedAt: true,
      },
    },
    _count: {
      select: {
        classes: true,
      },
    },
    courseAdmins: {
      select: {
        id: true,
        username: true,
        name: true,
        image: true,
        email: true,
        role: true,
        createdAt: true,
        updatedAt: true,
      },
    },
  },
});

courses.forEach((course) => {
  course.classes.sort((a, b) => {
    return Number(a.createdAt) - Number(b.createdAt);
  });
});

if (currentUser.role !== "INSTRUCTOR") {
  courses = [];
}
---

<RootLayout title="Assignments">
  <InstructorAssignments
    students={students}
    courses={courses}
    currentUser={currentUser}
    client:load
  />
</RootLayout>
