---
import RootLayout from "@/layouts/RootLayout.astro";
import { type SandpackFiles } from "@codesandbox/sandpack-react";
import Page from "./page";
import { createServerCaller } from "@/trpc/server";

const currentUser = Astro.locals.user!;
if (!currentUser) return Astro.redirect("/sign-in");

const assignmentId = Astro.url.searchParams.get("assignmentId");
const submissionId = Astro.url.searchParams.get("submissionId");

const caller = await createServerCaller(Astro.request);
const result = submissionId ? await caller.submission.getSubmissionById({ submissionId }) : null;

if (!result || !result.success || !result.data) {
  return Astro.redirect("/404");
}

const { data } = result;

const submission = data;

const initialFiles = submission?.data as SandpackFiles;

const studentAccess =
  currentUser.role === "STUDENT" && submission?.enrolledUser.username === currentUser.username;
const mentorAccess =
  currentUser.role === "MENTOR" && submission?.enrolledUser.mentorUsername === currentUser.username;
const instrctorAccess = currentUser.role === "INSTRUCTOR";

if (!studentAccess && !mentorAccess && !instrctorAccess && submissionId) {
  return Astro.redirect("/404");
}
---

<RootLayout>
  <Page
    currentUser={currentUser}
    assignmentId={assignmentId || ""}
    initialFiles={initialFiles}
    client:only
  />
</RootLayout>
