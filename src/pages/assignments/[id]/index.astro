---
import RootLayout from "@layouts/RootLayout.astro";
import Page from "./page";

const currentUser = Astro.locals.user;
if (!currentUser) return null;

const username = Astro.url.searchParams.get("username") || "";
const page = parseInt(Astro.url.searchParams.get("page") || "1");
const limit = parseInt(Astro.url.searchParams.get("limit") || "10");
const selectedMentor = Astro.url.searchParams.get("mentor") || "";
const searchQuery = Astro.url.searchParams.get("search") || "";
const skip = (page - 1) * limit;

import { createServerCaller } from "@/trpc/server";
const caller = await createServerCaller(Astro.request);

const data = await caller.assignments.getAssignmentDetailsPageData({
  id: Astro.params.id!,
  page,
  limit,
  searchQuery,
  selectedMentor,
  username,
  skip,
});
---

<RootLayout title="Assignments">
  <Page
    currentUser={currentUser}
    assignment={data?.assignment}
    sortedAssignments={data?.sortedAssignments ?? []}
    notSubmittedMentees={data?.notSubmittedMentees ?? []}
    isCourseAdmin={data?.isCourseAdmin ?? false}
    username={username ?? ""}
    mentors={data?.mentors as string[]}
    pagination={data?.pagination!}
    client:only="react"
  />
</RootLayout>
