---
import RootLayout from "@/layouts/RootLayout.astro";
import GetByAssignment from "./page.tsx";
import { createServerCaller } from "@/trpc/server";

const currentUser = Astro.locals.user;
if (!currentUser) return null;
const caller = await createServerCaller(Astro.request);
if (currentUser.role == "STUDENT") {
  return Astro.redirect("/assignments");
}
const courses = await caller.courses.getCoursesOfUser();


const coursesWithAssignments = await caller.courses.getAllAssignmentsInCourse({courses});
const sortedAssignments = coursesWithAssignments.map((course) => ({
  ...course,
  classes: course.classes
    .map((cls) => ({
      ...cls,
      attachments: cls.attachments.sort((a, b) => a.title.localeCompare(b.title)),
    }))
    .sort((a, b) => new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime()),
}));
---

<RootLayout title="Get By Assignments">
  <GetByAssignment sortedAssignments={sortedAssignments} courses={courses}/>
</RootLayout>
