---
import RootLayout from "@/layouts/RootLayout.astro";
import { createServerCaller } from "@/trpc/server";
import Page from './page'


const currentUser = Astro.locals.user;
if (!currentUser) return Astro.redirect("/sign-in");

const caller = await createServerCaller(Astro.request);
const {data} = await caller.leaderboard.getLeaderboardData();
if (!data) {
  throw new Error("Failed to fetch leaderboard data");
}

const {sortedSubmissions} = data;

const courses = await caller.courses.getCoursesForLeaderboard();

if(!courses) {
  throw new Error("Failed to fetch courses");
}

if (Array.isArray(courses)) {
  courses.forEach((course) => {
    course.classes.sort((a, b) => {
      return Number(a.createdAt) - Number(b.createdAt);
    });
  });
} else {
  throw new Error("Failed to fetch courses");
}

const publishedCourses = courses.filter((course) => course.isPublished);

const enrolledCourses = currentUser.role === "INSTRUCTOR" ? courses : publishedCourses;
---

<RootLayout title="Leaderboard">
  <Page sortedSubmissions={sortedSubmissions} enrolledCourses={enrolledCourses} currentUser={currentUser} client:load />
</RootLayout>
